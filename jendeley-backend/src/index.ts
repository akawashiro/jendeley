import { Command } from "commander";
import { startServer } from "./server";
import { genDB, genDummyDB } from "./gen";

async function main() {
  const program = new Command();

  program.name("jendeley");

  program
    .command("gen")
    .requiredOption("--papers_dir <dir>", "Root directory of your papers")
    .option("--book_dirs <dirs>", "Comma separated directories of books")
    .option(
      "--db_name <db_name>",
      "Name of DB. DB is created under <papers_dir>. By default, <papers_dir>/db.json."
    )
    .option("--only_append", "Do not overwrite existing entries in DB")
    .action((cmd, options) => {
      const book_dirs_str =
        options._optionValues.book_dirs == undefined
          ? ""
          : options._optionValues.book_dirs;
      // TODO: Get OS independent path delimiter.
      const pd =
        options._optionValues.papers_dir.slice(-1) == "/"
          ? options._optionValues.papers_dir
          : options._optionValues.papers_dir + "/";
      const db_name = options._optionValues.db_name == undefined ? "db.json" : options._optionValues.db_name;
      genDB(
        pd,
        book_dirs_str,
        db_name,
        options._optionValues.only_append
      );
    });

  program
    .command("gen-dummy")
    .requiredOption("--output <out>", "Output DB to this file.")
    .action((cmd, options) => {
      genDummyDB(options._optionValues.output);
    });

  program
    .command("server")
    .requiredOption("--db <db>", "DB file generated by gen command")
    .action((cmd, options) => {
      startServer(options._optionValues.db);
    });

  program.parse();
}

main().then((_arg) => {});
